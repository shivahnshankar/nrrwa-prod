{{ define "main" }}
{{ $allNews := where .Site.RegularPages "Section" "news" }}
{{ $langNews := where $allNews ".Language.Lang" .Language.Lang }}
{{ $langNews = where $langNews "Params.layout" "!=" "archive" }}
<div class="container">
  <h1 class="section-title">{{ if eq .Language.Lang "en" }}Community News{{ else }}‡≤∏‡≤Æ‡≥Å‡≤¶‡≤æ‡≤Ø ‡≤∏‡≥Å‡≤¶‡≥ç‡≤¶‡≤ø{{ end }}</h1>

  <div class="content-with-sidebar">
    <div>
      <!-- News Posts -->
      <div class="news-list-horizontal">
        {{ $paginator := .Paginate $langNews }}
        {{ range $index, $page := $paginator.Pages }}
        <article class="news-card-horizontal{{ if mod $index 2 }} reverse{{ end }}">
          <div class="news-image-horizontal">
            {{ with $page.Params.featuredImage }}
            {{ $img := resources.Get . }}
            {{ if $img }}
              {{ $resized := $img.Fill "400x300 webp q85" }}
              <img src="{{ $resized.RelPermalink }}" alt="{{ $page.Title }}">
            {{ else }}
              <img src="{{ . }}" alt="{{ $page.Title }}">
            {{ end }}
            {{ else }}
            <div class="news-placeholder">üì∞</div>
            {{ end }}
          </div>

          <div class="news-content-horizontal">
            <div class="blog-meta">
              <span>üìÖ {{ $page.Date.Format "02 Jan 2006" }}</span>
              {{ with $page.Params.tags }}
              <span>üè∑Ô∏è
                {{ range $index, $tag := . }}
                  {{ if $index }}, {{ end }}<a href="{{ "/tags/" | relLangURL }}{{ $tag | urlize }}/" style="color: var(--primary-blue); text-decoration: none;">{{ $tag }}</a>
                {{ end }}
              </span>
              {{ end }}
            </div>
            <h3 class="news-title">{{ $page.Title }}</h3>
            <p class="news-summary">{{ $page.Params.summary }}</p>
            <a href="{{ $page.Permalink }}" class="news-link">{{ if eq $.Language.Lang "en" }}Read More{{ else }}‡≤á‡≤®‡≥ç‡≤®‡≤∑‡≥ç‡≤ü‡≥Å ‡≤ì‡≤¶‡≤ø{{ end }} ‚Üí</a>
          </div>
        </article>
        {{ end }}
      </div>

      <!-- Hugo Built-in Pagination -->
      {{ template "_internal/pagination.html" . }}
    </div>

    <aside class="sidebar">
      <h3>{{ if eq .Language.Lang "en" }}Tags{{ else }}‡≤ü‡≥ç‡≤Ø‡≤æ‡≤ó‡≥ç‚Äå‡≤ó‡≤≥‡≥Å{{ end }}</h3>
      <ul>
        {{ $newsTags := dict }}
        {{ range $langNews }}
          {{ range .Params.tags }}
            {{ $count := index $newsTags . | default 0 }}
            {{ $newsTags = merge $newsTags (dict . (add $count 1)) }}
          {{ end }}
        {{ end }}
        {{ range $tag, $count := $newsTags }}
        <li>
          <a href="{{ "/tags/" | relLangURL }}{{ $tag | urlize }}/">
            {{ $tag }}
            <span style="color: #999; font-size: 0.9em;">({{ $count }})</span>
          </a>
        </li>
        {{ end }}
      </ul>

      <h3 style="margin-top: 2rem;">{{ if eq .Language.Lang "en" }}Archive{{ else }}‡≤Ü‡≤∞‡≥ç‡≤ï‡≥à‡≤µ‡≥ç{{ end }}</h3>
      <ul>
        {{ $newsPages := where $langNews "Params.layout" "!=" "archive" }}
        {{ $years := slice }}
        {{ range $newsPages }}
          {{ $year := .Date.Format "2006" }}
          {{ if not (in $years $year) }}
            {{ $years = $years | append $year }}
          {{ end }}
        {{ end }}
        {{ range sort $years "value" "desc" }}
        <li>
          <a href="{{ "/news/news-archive/" | relLangURL }}#{{ . }}">
            {{ . }}
            <span style="color: #999; font-size: 0.9em;">({{ len (where $newsPages "Date.Year" (int .)) }})</span>
          </a>
        </li>
        {{ end }}
      </ul>
    </aside>
  </div>
</div>
{{ end }}
